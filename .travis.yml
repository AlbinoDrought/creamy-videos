language: go

go:
  - 1.11.x

services:
  - postgresql

env:
  global:
    - CREAMY_POSTGRES_USER=creamy
    - CREAMY_POSTGRES_PASSWORD=videos
    - CREAMY_POSTGRES_DATABASE=creamy_videos
  matrix:
    - CREAMY_POSTGRES=true
    - CREAMY_POSTGRES=false

# install node
before_install:
  - . $HOME/.nvm/nvm.sh # https://stackoverflow.com/a/43106527/3649573
  - nvm install stable
  - nvm use stable
  - psql -c "CREATE DATABASE creamy_videos;" -U postgres
  - psql -c "CREATE USER creamy WITH PASSWORD 'videos';" -U postgres

install:
  - go get -u github.com/gobuffalo/packr/v2/packr2
  - go get
  - cd ui && npm install && cd ..

before_script:
  - go vet
  - cd ui && npm run lint && cd ..

script:
  - cd ui && npm run build && cd ..
  - packr2 build
  - ./creamy-videos serve &
  - sleep 2 # give it time to start
  - cd ui && npm run test:e2e -- --headless --url http://localhost:3000/
